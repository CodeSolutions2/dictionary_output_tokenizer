<!DOCTYPE html>
<html>
<head></head>
<body>

<!-- Text classification webapp -->
<!-- https://js.tensorflow.org/api/1.0.0/ -->
<h1 style='text-align: center; margin-bottom: -35px;'>Text classification webapp</h1>
<br><br>

<!-- [Step 0] Train model -->
<label for="train_dataset_url_label" style="display:block">Enter train dataset location url - url can be Github or GCP storage: (ie: https://github.com/CodeSolutions2/text_classification_w_labels/train_dataset0.csv)</label>
<input type="text" value="" placeholder="Train dataset url" id="train_dataset_url" rows="1" cols="500" size="200" style="display:block">
<br><br>
<label for="y_datasetLabels_label" style="display:block">Enter the y dataset labels: (ie: sport,business,politics,entertainment,tech)</label>
<input type="text" value="" placeholder="y dataset labels" id="y_datasetLabels" rows="1" cols="500" size="200" style="display:block">
<br>
<button id="train_model" onclick="train_model()" style="display:block">train_model</button>

	
<!-- [Step 1] Result: say if model is trained or not -->
<div id="output" style="font-family:courier;font-size:24px;height:300px"></div>

	
<!-- [Step 2] Predict/inference: predict each sentence separated by a \n character -->
<label for="input_text_label" style="display:none">Enter text to label, each sentence separated by the \n character will be labeled:</label>
<input type="text" value="" placeholder="Enter text to label" id="input_text" rows="10" cols="500" style="display:none">



	
<!-- https://developer.mozilla.org/en-US/docs/Web/CSS/position -->
<style>
canvas {border: 1px solid black; position: absolute; display: inline-block; z-index: 1; top: 150px;},
div {position: relative; z-index: 2;},
table {border-collapse: collapse;}
td,
th {border: 1px solid black; padding: 10px 20px;}
</style>

<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest"></script>
<!-- <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs-node@4.17.0/dist/index.min.js"></script> -->

<script>

  // -------------------------------------------------
	
  const outp = document.getElementById('output');

  var csvDataset = [];  // This is a global variable

  var vocab_size = 0;  // This is a global variable, that will be reassigned after button push

  var maxlen = 0;  // This is a global variable, that will be reassigned after button push
	
  var class_names = []; // This is a global variable, that will be reassigned after button push




  // -------------------------------------------------

  async function get_csvDataset(csvDataset) {

	// https://github.com/CodeSolutions2/text_classification_w_labels/train_dataset0.csv
	// https://storage.googleapis.com/textclassification-w-labeled-data/train_dataset0.csv
	  
	const datasetUrl = document.getElementById("train_dataset_url").value;

	let out = datasetUrl.split("/");
	// console.log("out:" + out);
	
	let domain_name = out[2];
	// console.log("domain_name:" + domain_name);

	  var url_vec = [];
	
	if (domain_name == 'github.com'){
		const repoOwner = out[3];
		const repoName = out[4];
		
		var url = `https://api.github.com/repos/${repoOwner}/${repoName}/contents`;
		
		    await fetch(url).then(res => res.json()).then(data => {
		    data.forEach(file => {
		      if (file.type === 'file' && file.name.match(/.(csv|txt)$/i)) {
			url_vec.push(file.download_url);
		      }
		    });
		  }).catch(error => { outp.innerHTML += error; });

		console.log("url_vec:" + url_vec);
		
    // Select the first dataset from the url list
    const csvUrl = url_vec[0];
    console.log("csvUrl: " + csvUrl);

    // Make a Dataset  
    // X and y (dataset object)
    csvDataset = await tf.data.csv(csvUrl, { columnConfigs: { Y: {isLabel: true} } });
    console.log("csvDataset: " + csvDataset);  // csvDataset: [object Object]
		

	} else if (domain_name == 'storage.googleapis.com') {

	   //    const BUCKET_NAME = out[3];
	//  const fileName = out[4];
		// var url = `https://storage.googleapis.com//${BUCKET_NAME}/${fileName}`;

		// var options = {method : 'get', headers: {'Content-Type': "application/json", 'Access-Control-Allow-Origin': '*'}, mode: 'cors'};
		
		// await fetch(url, options).then(res => res.json()).then(data => {
		//     data.forEach(file => {
		 //      if (file.type === 'file' && file.name.(/.(csv|txt)$/i)) {
			// url_vec1.push(file.download_url);
		 //      }
		  //   });
		//   }).catch(error => { outp.innerHTML += error; });
		
		// OR
		
		// url_vec.push(datasetUrl);

		// OR

		 // Create <form> element to submit parameters to endpoint.
    //     var form = document.createElement('form');

       // form.setAttribute('method', 'GET'); 
     //   var url = 'https://storage.googleapis.com/textclassification-w-labeled-data';
   //      form.setAttribute('action', url);

        // Parameters to pass to endpoint.
  //       var params = {'key': 'train_dataset0.csv'};

        // Add form parameters as hidden input values.
    //     for (var p in params) {
     //      var input = document.createElement('input');
     //      input.innerHTML = '<input style="display:none;" name=' +p+ 'value=' +params[p]+ '>';

		// https://storage.googleapis.com/textclassification-w-labeled-data?keytype%3D%22text%22=train_dataset0.csv
		// https://storage.googleapis.com/textclassification-w-labeled-data?keyvalue%3Dtrain_dataset0.csv=
          
 //          form.appendChild(input);
 //        }
        // Add form to page and submit it to open the endpoint.
  //       document.body.appendChild(form);

   //      form.submit();
		
    //     url_vec.push( url + '/' + params['key'] );

        // Cross-Origin Request Blocked: The Same Origin Policy disallows reading the remote resource at https://storage.googleapis.com/textclassification-w-labeled-data/train_dataset0.csv. (Reason: CORS header ‘Access-Control-Allow-Origin’ missing). Status code: 200

		// console.log("url_vec:" + url_vec);

		// OR

		const BUCKET_NAME = out[3];
		const fileName = out[4];
		var url = `https://storage.googleapis.com//${BUCKET_NAME}/${fileName}`;
		var options = {method : 'get', headers: {'Access-Control-Allow-Origin': '*'
							}, mode: 'no-cors'};

		csvDataset = await fetch(url, options).then(res => res).then(res => {   
		 const out = tf.data.csv(res.text(), { columnConfigs: { Y: { isLabel: true } } });
		 console.log("out: " + out.toString() );
		 return out; }).catch(error => { outp.innerHTML += error; });

		// OR

		// The key "Y" provided in columnConfigs does not  any of the column names (<!DOCTYPE html>).
		// const response = await fetch(url, { mode: 'no-cors' });
		// const data = await response.text();
		// csvDataset = tf.data.csv(data, { columnConfigs: { Y: { isLabel: true } } });
		
	} else {
		outp.innerHTML = 'Please enter a GitHub repository or Google Cloud Platform Storage URL';
	}
 
	return csvDataset;
  }

	
	
  // -------------------------------------------------

	
  async function put_results_in_CSVfile(pred_vec) {
    
    // ---------------------
    // Puts array into csv format
    const blob = new Blob([pred_vec], { type: 'text/csv;charset=utf-8;' });

    // Create a url for the data object
    const url = URL.createObjectURL(blob);
    // ---------------------
    // OR
    // ---------------------
    // Puts array into csv format
    // let csvContent = "data:text/csv; charset=utf-8";
    // pred_vec.forEach(function(row_array) {
	// csvContent += row_array.join(",") + "\r\n";
    // });
    // OR
    // let csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
	  
    // Create a url for the data object
    // var url = encodeURI(csvContent);
    // ---------------------

    const link = document.createElement("a");
    link.setAttribute("href", url);

    const filename = 'data.csv';
    link.setAttribute("download", filename);
	  
    link.style.display = 'block';

    outp.innerHTML += 'Download CSV here: ' + url + "<br/>";
    // document.body.appendChild(link);

    // Automatic download of csv
    // link.click();
    // document.body.removeChild(link);
	  
  }

	
  // -------------------------------------------------

	
  async function generateTable_dynamically(pred_vec) {

  	const tbl = document.createElement("table");
  
  	const tblBody = document.createElement("tbody");
  
  	// Create row cells dynamically
  	for (let i=0; i < pred_vec.length; i++){
  		// create a table row
  		const row = document.createElement("tr");
  
  		for (let j=0; j < pred_vec[0].length; j++){
  			const cell = document.createElement("td");
  			const cellText = document.createTextNode(`${pred_vec[i][j]}`);
  			cell.appendChild(cellText);
  			row.appendChild(cell);
  		}
  
  		// add a row to the end of the table
  		tblBody.appendChild(row);
  	}
  	tbl.appendChild(tblBody);
  
  	document.body.appendChild(tbl);

  }  

  // -------------------------------------------------

	
</script>
</body>
</html>
